# Knowledge Graph Visualization Enhancement
summary: Deep analysis of how to improve the temporal knowledge graph visualization with subagent types, message trajectories, and better commit attribution
storm_id: 001
date: 2025-12-16
time: 08:30:00
tags:
- knowledge-graph
- visualization
- subagents
- traceability
- falkordb
- vis.js
tasks:
- [ ] Add SubagentType nodes to the graph schema
- [ ] Parse Task tool_use events to extract subagent_type
- [ ] Link AgentExecution nodes to SubagentType via IS_TYPE relationship
- [ ] Add UserMessage and AssistantMessage nodes with THEN relationships
- [ ] Parse agent transcripts for git commit tool calls
- [ ] Create timeline-based visualization option
- [ ] Add hierarchical clustering by subagent type
related_storms:
- (none, first storm)

## User Input
Can you brainstorm on how to make this graph more useful / intuitive / explanatory / user friendly? Like I would like to see trajectories from user submits to agent responses so I can see like the trajectory of a transcript. And commits should be associated with specific agent responses where the agent made a commit. And commits should be associated with subagents of which I believe we have 25 defined. So we should see a node category for subagents and there should be about 25 of them. Can you do some brainstorming on how to approach this and what is going to be required to achieve this in the most elegant way that has useful and visually pleasant qualities to the graph? (ie human readable information that is useful and intuitive).

## Reflection

### Current State Analysis

**What We Have:**
- 31 Sessions (green nodes)
- 332 Agent Executions (blue nodes - all look the same)
- 73 Commits (orange nodes)
- 97 LIKELY_BY correlations (timestamp-based, 120s window)

**Current Limitations:**
1. All agents appear as homogeneous blue boxes with hex IDs
2. No subagent type classification visible
3. No message-level granularity (can't see user â†’ assistant flow)
4. Timestamp correlation is fuzzy (may correlate wrong agent)
5. Can't see what tools an agent used
6. Can't trace commit to exact tool call

---

### Discovery: Subagent Types in This Repository

**From Log Analysis - 15 types actually used:**
| Type | Uses | Category |
|------|------|----------|
| Explore | 82 | Built-in |
| general-purpose | 52 | Built-in |
| claude-code-guide | 14 | Built-in |
| backend-architect | 5 | Project |
| agent-architect | 5 | Project |
| systems-thinker | 4 | Project |
| archivist | 4 | Project/Plugin |
| Plan | 3 | Built-in |
| process-cartographer | 2 | Project |
| awareness:mentor | 2 | Plugin |
| temporal-validator | 1 | Project |
| qa-engineer | 1 | Project |
| logging:archivist | 1 | Plugin |
| librarian | 1 | Project |
| agentnet:engineer | 1 | Plugin |

**Defined Agents (~40 total):**

*Project Agents (.claude/agents/):*
- backend-architect, systems-thinker, process-cartographer
- temporal-validator, librarian, agent-architect
- git-historian, qa-engineer, obsidian-quartz, archivist

*Plugin Agents:*
- agentnet: social-curator, engineer
- agents: orchestrator
- awareness: mentor, style
- backlog: taskmaster
- brainstorm: muse
- exploration: explorer
- interface: interface-navigator
- journal: scribe
- knowledge-graphs: weaver
- llms: modeler
- logging: archivist
- Schedule.md: timekeeper
- temporal: chronologist

*Built-in Agents:*
- Explore, Plan, claude-code-guide, general-purpose, statusline-setup

---

### Proposed Graph Schema Enhancement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENHANCED GRAPH MODEL                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ SubagentType â”‚  â† NEW: "Explore", "Plan", "archivist", etc.  â”‚
â”‚  â”‚   (archetype)â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚ IS_TYPE                                               â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      SPAWNED       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚AgentExecutionâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Session â”‚               â”‚
â”‚  â”‚  (hex ID)    â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚                     â”‚
â”‚         â”‚ MADE_COMMIT                     â”‚ NEXT_SESSION        â”‚
â”‚         â–¼ (exact)                         â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      LIKELY_BY     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚    Commit    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Session â”‚               â”‚
â”‚  â”‚  (git hash)  â”‚    (fallback)      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                 â”‚
â”‚  NEW: Message Flow                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  PROMPTED  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ UserMessage â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚AssistantMessage â”‚                 â”‚
â”‚  â”‚  (prompt)   â”‚           â”‚   (response)    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚ IN_SESSION                â”‚ SPAWNED_AGENT            â”‚
â”‚         â–¼                           â–¼                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ Session â”‚              â”‚AgentExecutionâ”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Implementation Approaches

#### Approach A: Hierarchical Clustering (Visual)
**Concept:** Keep current data, but visually group agents by type
- Use vis.js clustering to group agents under their SubagentType
- Expand/collapse clusters on click
- Color-code by category (built-in vs project vs plugin)

**Pros:** Quick to implement, no schema change needed
**Cons:** Still using fuzzy timestamp correlation

#### Approach B: Deep Parsing (Data Quality)
**Concept:** Parse transcripts to extract exact commit attribution
- When an agent does `git commit`, capture the commit hash from tool output
- Create MADE_COMMIT relationship (exact, not timestamp-based)
- Parse Task tool_use to get subagent_type before agent starts

**Pros:** Precise attribution, rich data
**Cons:** Requires parsing all transcripts (332 agents Ã— ~100KB each)

#### Approach C: Hybrid (Recommended)
**Concept:** Combine both approaches
1. Add SubagentType nodes from Task tool_use events (quick)
2. Add message-level nodes for trajectory view (medium)
3. Optionally deep-parse transcripts for high-value agents (targeted)

---

### Visual Design Recommendations

#### 1. Node Shapes by Category
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®   â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡
â”‚ Session â”‚   â”‚ Commit  â”‚   â”‚ Agent   â”‚   â”‚SubType  â”‚
â”‚ (rect)  â”‚   â”‚ (rect)  â”‚   â”‚ (round) â”‚   â”‚(diamond)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯   â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡
   Green        Orange        Blue         Purple
```

#### 2. Color Palette by Agent Category
```
Built-in agents:  #2196F3 (Blue)
Project agents:   #9C27B0 (Purple)
Plugin agents:    #00BCD4 (Cyan)
Sessions:         #4CAF50 (Green)
Commits:          #FF9800 (Orange)
Messages:         #E91E63 (Pink)
```

#### 3. Human-Readable Labels
Instead of: `ğŸ¤– a52772e`
Show: `ğŸ” Explore: "find auth endpoints"`

**Label Template:**
```
{emoji} {type}
{description[:30]}
{timestamp_relative}
```

#### 4. Edge Styling
- SPAWNED: Solid green, arrow to agent
- IS_TYPE: Dashed purple, to archetype
- MADE_COMMIT: Thick orange, high confidence
- LIKELY_BY: Thin orange dashed, timestamp correlation
- PROMPTED: Pink arrow, message flow
- THEN: Gray dotted, sequence

---

### Timeline View (Alternative Layout)

```
TIME â†’
â”‚
â”œâ”€ 14:00 â”€â”€â”¬â”€â”€ UserMessage: "Add authentication"
â”‚          â”‚
â”œâ”€ 14:01 â”€â”€â”œâ”€â”€ AssistantMessage (spawns agents)
â”‚          â”‚    â”œâ”€â”€ Explore:a52772e "find auth patterns"
â”‚          â”‚    â””â”€â”€ Plan:ae77ce9 "design auth flow"
â”‚          â”‚
â”œâ”€ 14:03 â”€â”€â”œâ”€â”€ Explore:a52772e completes
â”‚          â”‚
â”œâ”€ 14:05 â”€â”€â”œâ”€â”€ Plan:ae77ce9 completes
â”‚          â”‚
â”œâ”€ 14:06 â”€â”€â”œâ”€â”€ AssistantMessage (implements)
â”‚          â”‚
â”œâ”€ 14:08 â”€â”€â””â”€â”€ Commit:addf0b9c "Add auth middleware"
â”‚                    â””â”€â”€ MADE_COMMIT â†’ Plan:ae77ce9
```

**Vis.js Implementation:**
- Use timeline mode or custom positioning
- X-axis = time, Y-axis = session/agent lanes
- Zoom in/out of time ranges

---

### Data Extraction Requirements

#### 1. SubagentType from Task tool_use
```python
# In ingest_all_sessions.py
for event in events:
    if event['type'] == 'tool_use' and event['tool_name'] == 'Task':
        subagent_type = event['tool_input'].get('subagent_type')
        description = event['tool_input'].get('description')
        # Store for later matching with SubagentStop
```

#### 2. Commit from Bash tool_result
```python
# In agent transcript parsing
for event in transcript:
    if event['type'] == 'tool_result' and 'git commit' in str(event):
        # Parse commit hash from output
        # Create MADE_COMMIT edge
```

#### 3. Message Flow
```python
# Already have UserMessage/AssistantMessage in schema
# Add THEN relationships based on timestamp ordering
# Add SPAWNED_AGENT from tool_use â†’ SubagentStop correlation
```

---

### Sidebar Enhancements

**For SubagentType node:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBAGENT TYPE               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Type: Explore               â”‚
â”‚ Category: Built-in          â”‚
â”‚ Total Executions: 82        â”‚
â”‚ Avg Duration: ~45s          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RECENT EXECUTIONS           â”‚
â”‚ â€¢ a52772e (2h ago)          â”‚
â”‚ â€¢ b38cd91 (3h ago)          â”‚
â”‚ â€¢ c91ae23 (5h ago)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**For Commit with exact attribution:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMMIT                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hash: addf0b9c              â”‚
â”‚ Message: Add auth middlewareâ”‚
â”‚ Time: 2025-12-13 14:08      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ATTRIBUTION                 â”‚
â”‚ Method: Exact (tool call)   â”‚
â”‚ Agent: Plan:ae77ce9         â”‚
â”‚ Session: 7f5d9f72           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TRAJECTORY                  â”‚
â”‚ User â†’ "Add authentication" â”‚
â”‚   â””â†’ Plan:ae77ce9           â”‚
â”‚      â””â†’ This commit         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Implementation Phases

**Phase 1: SubagentType Nodes (Quick Win)**
- Parse Task tool_use events from existing logs
- Create SubagentType nodes for each unique type
- Create IS_TYPE relationships
- Update visualization with type labels and clustering
- Estimated: 2-4 hours of work

**Phase 2: Message-Level Graph (Medium)**
- Parse UserMessage/AssistantMessage events
- Create PROMPTED and THEN relationships
- Link messages to spawned agents
- Add trajectory view mode
- Estimated: 4-8 hours of work

**Phase 3: Deep Transcript Parsing (Optional)**
- Parse agent transcripts for tool calls
- Extract exact commit attribution from Bash results
- Create MADE_COMMIT relationships
- Estimated: 8-16 hours of work (332 transcripts)

**Phase 4: Timeline Visualization (Enhancement)**
- Implement timeline layout option
- Add time-based filtering
- Session swimlanes
- Estimated: 4-8 hours of work

---

### Key Files to Modify

1. **ingest_all_sessions.py** - Add SubagentType extraction, message parsing
2. **generate_graph_viewer.py** - Add new node types, clustering, timeline
3. **New: parse_transcripts.py** - Deep transcript parsing for exact attribution
4. **query_sessions.py** - Add `type <name>` command for subagent type queries

---

### Success Metrics

After implementation, the graph should answer:
1. "What types of agents do we use most?" â†’ SubagentType node sizes
2. "Show me the trajectory of this conversation" â†’ Message flow view
3. "Which agent made this commit?" â†’ Exact MADE_COMMIT edge
4. "What did the Explore agents find?" â†’ Type-filtered view
5. "How do agents collaborate in a session?" â†’ Timeline swimlanes

---
