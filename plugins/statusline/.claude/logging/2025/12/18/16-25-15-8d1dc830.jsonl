{"ts": "2025-12-18T16:25:15.198667", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "jq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd | startswith($cwd))).key // empty' /home/ygg/.claude/instances/registry.json", "description": "Single line test"}, "tool_use_id": "toolu_012t9JHx2Zq8d3b4hc2GwcsZ"}}
{"ts": "2025-12-18T16:25:15.854864", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "jq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd | startswith($cwd))).key // empty' /home/ygg/.claude/instances/registry.json", "description": "Single line test"}, "tool_response": {"stdout": "835d7c4b-361c-4a49-82a1-3ab400150ee6", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_012t9JHx2Zq8d3b4hc2GwcsZ"}}
{"ts": "2025-12-18T16:25:24.159861", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "target_cwd=\"/home/ygg/Workspace/sandbox/marketplaces/claude\"\nregistry=\"$HOME/.claude/instances/registry.json\"\nresult=$(jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd == $cwd or (.ncwd | startswith($cwd + \"/\")) or ($cwd | startswith(.ncwd + \"/\")))).key // empty' \"$registry\")\necho \"Result: $result\"", "description": "Single line with all conditions"}, "tool_use_id": "toolu_01V3H1AR3M6JSq93puswt2wv"}}
{"ts": "2025-12-18T16:25:24.758519", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "target_cwd=\"/home/ygg/Workspace/sandbox/marketplaces/claude\"\nregistry=\"$HOME/.claude/instances/registry.json\"\nresult=$(jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd == $cwd or (.ncwd | startswith($cwd + \"/\")) or ($cwd | startswith(.ncwd + \"/\")))).key // empty' \"$registry\")\necho \"Result: $result\"", "description": "Single line with all conditions"}, "tool_response": {"stdout": "Result:\njq: error (at /home/ygg/.claude/instances/registry.json:280): Cannot index string with string \"ncwd\"", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_01V3H1AR3M6JSq93puswt2wv"}}
{"ts": "2025-12-18T16:25:32.071198", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 1: .ncwd == $cwd\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd == $cwd)).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 1"}, "tool_use_id": "toolu_01PXmVTM3ZSQz6i7fxTFBMjG"}}
{"ts": "2025-12-18T16:25:33.584671", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 1: .ncwd == $cwd\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd == $cwd)).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 1"}, "tool_response": {"stdout": "none", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_01PXmVTM3ZSQz6i7fxTFBMjG"}}
{"ts": "2025-12-18T16:25:39.821134", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 2: .ncwd | startswith($cwd + \"/\")\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd | startswith($cwd + \"/\"))).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 2"}, "tool_use_id": "toolu_01DjriqtgHBK3FJ5AxJ7R5yN"}}
{"ts": "2025-12-18T16:25:41.283350", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 2: .ncwd | startswith($cwd + \"/\")\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(.ncwd | startswith($cwd + \"/\"))).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 2"}, "tool_response": {"stdout": "835d7c4b-361c-4a49-82a1-3ab400150ee6", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_01DjriqtgHBK3FJ5AxJ7R5yN"}}
{"ts": "2025-12-18T16:25:48.429868", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 3: $cwd | startswith(.ncwd + \"/\")\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select($cwd | startswith(.ncwd + \"/\"))).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 3"}, "tool_use_id": "toolu_012AsKCFips53LYKfbubMn5V"}}
{"ts": "2025-12-18T16:25:59.414650", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# Test condition 3 with proper scoping\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg 'first(to_entries[] | select(.value.cwd) | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} | select(($cwd | startswith(.ncwd + \"/\")))).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test condition 3 with parens"}, "tool_use_id": "toolu_01X8sZMY2awAj6S1jxh8bT6x"}}
{"ts": "2025-12-18T16:26:11.716578", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# Using as $x pattern\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg '\nfirst(\n  to_entries[] \n  | select(.value.cwd) \n  | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} \n  | . as $x \n  | select($cwd | startswith($x.ncwd + \"/\"))\n).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test with as pattern"}, "tool_use_id": "toolu_019h996LXbPj5F7t6riRdhZt"}}
{"ts": "2025-12-18T16:26:13.617641", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "# Using as $x pattern\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg '\nfirst(\n  to_entries[] \n  | select(.value.cwd) \n  | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} \n  | . as $x \n  | select($cwd | startswith($x.ncwd + \"/\"))\n).key // \"none\"' ~/.claude/instances/registry.json", "description": "Test with as pattern"}, "tool_response": {"stdout": "none", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_019h996LXbPj5F7t6riRdhZt"}}
{"ts": "2025-12-18T16:26:22.164194", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "# All conditions combined\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg '\nfirst(\n  to_entries[] \n  | select(.value.cwd) \n  | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} \n  | . as $x \n  | select(\n      $x.ncwd == $cwd or \n      ($x.ncwd | startswith($cwd + \"/\")) or \n      ($cwd | startswith($x.ncwd + \"/\"))\n    )\n).key // empty' ~/.claude/instances/registry.json", "description": "All conditions with as pattern"}, "tool_use_id": "toolu_019KSdootKRfNFmDPGoEcQC6"}}
{"ts": "2025-12-18T16:26:23.774319", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "# All conditions combined\njq -r --arg cwd /home/ygg/Workspace/sandbox/marketplaces/claude --arg home /home/ygg '\nfirst(\n  to_entries[] \n  | select(.value.cwd) \n  | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))} \n  | . as $x \n  | select(\n      $x.ncwd == $cwd or \n      ($x.ncwd | startswith($cwd + \"/\")) or \n      ($cwd | startswith($x.ncwd + \"/\"))\n    )\n).key // empty' ~/.claude/instances/registry.json", "description": "All conditions with as pattern"}, "tool_response": {"stdout": "835d7c4b-361c-4a49-82a1-3ab400150ee6", "stderr": "", "interrupted": false, "isImage": false}, "tool_use_id": "toolu_019KSdootKRfNFmDPGoEcQC6"}}
{"ts": "2025-12-18T16:26:37.016104", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline/lib/session-resolver.sh", "old_string": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        def norm: gsub(\"^~\"; $home);\n\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | norm)}\n            | select(\n                .ncwd == $cwd or\n                (.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith(.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null", "new_string": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))}\n            | . as $x\n            | select(\n                $x.ncwd == $cwd or\n                ($x.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith($x.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null"}, "tool_use_id": "toolu_01Nz8Hi8TJez5ARhQWSGGhNW"}}
{"ts": "2025-12-18T16:26:37.578184", "type": "PostToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline/lib/session-resolver.sh", "old_string": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        def norm: gsub(\"^~\"; $home);\n\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | norm)}\n            | select(\n                .ncwd == $cwd or\n                (.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith(.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null", "new_string": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))}\n            | . as $x\n            | select(\n                $x.ncwd == $cwd or\n                ($x.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith($x.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null"}, "tool_response": {"filePath": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline/lib/session-resolver.sh", "oldString": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        def norm: gsub(\"^~\"; $home);\n\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | norm)}\n            | select(\n                .ncwd == $cwd or\n                (.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith(.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null", "newString": "    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))}\n            | . as $x\n            | select(\n                $x.ncwd == $cwd or\n                ($x.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith($x.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null", "originalFile": "#!/bin/bash\n#\n# Session Resolver - Map tmux panes to Claude session IDs\n#\n# Resolves a tmux pane's working directory to the corresponding Claude session_id\n# by matching against the registry.json cwd field.\n#\n# Source this file from scripts:\n#   source \"$SCRIPT_DIR/../lib/session-resolver.sh\"\n#\n# Dependencies:\n#   - jq for JSON parsing\n#   - tmux for pane information\n#\n# Usage:\n#   session_id=$(resolve_session \"main:0.0\")\n#   session_id=$(resolve_session_by_cwd \"/home/user/project\")\n\n# ============================================================================\n# Configuration\n# ============================================================================\n\nSTATUSLINE_INSTANCES_DIR=\"${STATUSLINE_INSTANCES_DIR:-$HOME/.claude/instances}\"\n\n# ============================================================================\n# Core Resolution Functions\n# ============================================================================\n\n# Resolve a tmux pane reference to a Claude session_id\n#\n# Usage: resolve_session <pane_ref>\n#\n# Arguments:\n#   pane_ref - tmux pane reference in format \"session:window.pane\"\n#\n# Returns:\n#   Session ID on stdout if found, empty string if not\n#\n# Example:\n#   session_id=$(resolve_session \"main:0.0\")\n#\nresolve_session() {\n    local pane_ref=\"$1\"\n\n    # Get the pane's working directory\n    local pane_cwd\n    pane_cwd=$(tmux display-message -t \"$pane_ref\" -p '#{pane_current_path}' 2>/dev/null) || return 1\n\n    if [[ -z \"$pane_cwd\" ]]; then\n        return 1\n    fi\n\n    # Resolve by cwd\n    resolve_session_by_cwd \"$pane_cwd\"\n}\n\n# Resolve a working directory path to a Claude session_id\n#\n# Searches registry.json for a session matching the given cwd.\n# Matching strategies (in order of preference):\n#   1. Exact match\n#   2. Session CWD is subdirectory of target (session started in subdir, pane at parent)\n#   3. Target CWD is subdirectory of session (pane navigated into subdir)\n#\n# Returns the most recently active session if multiple match.\n#\n# Usage: resolve_session_by_cwd <path>\n#\n# Arguments:\n#   path - Absolute path to working directory\n#\n# Returns:\n#   Session ID on stdout if found, empty string if not\n#\nresolve_session_by_cwd() {\n    local target_cwd=\"$1\"\n    local registry=\"${STATUSLINE_INSTANCES_DIR}/registry.json\"\n\n    if [[ ! -f \"$registry\" ]]; then\n        return 1\n    fi\n\n    # Normalize the path (expand ~ if present, resolve symlinks)\n    target_cwd=$(realpath -m \"$target_cwd\" 2>/dev/null || echo \"$target_cwd\")\n\n    # Find matching session by cwd with flexible matching\n    # Matches: exact, session in subdir of pane, or pane in subdir of session\n    jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '\n        def norm: gsub(\"^~\"; $home);\n\n        first(\n            to_entries[]\n            | select(.value.cwd)\n            | {key, ncwd: (.value.cwd | norm)}\n            | select(\n                .ncwd == $cwd or\n                (.ncwd | startswith($cwd + \"/\")) or\n                ($cwd | startswith(.ncwd + \"/\"))\n            )\n        ).key // empty\n    ' \"$registry\" 2>/dev/null\n}\n\n# Get session data for a session_id\n#\n# Usage: get_session_data <session_id>\n#\n# Returns:\n#   JSON object with session data on stdout\n#\nget_session_data() {\n    local session_id=\"$1\"\n    local registry=\"${STATUSLINE_INSTANCES_DIR}/registry.json\"\n\n    if [[ ! -f \"$registry\" ]]; then\n        echo \"{}\"\n        return 1\n    fi\n\n    jq -r --arg sid \"$session_id\" '.[$sid] // {}' \"$registry\" 2>/dev/null\n}\n\n# Get all active sessions as JSON array\n#\n# Usage: get_active_sessions\n#\n# Returns:\n#   JSON array of {session_id, name, cwd, task, model, ...} objects\n#\nget_active_sessions() {\n    local registry=\"${STATUSLINE_INSTANCES_DIR}/registry.json\"\n\n    if [[ ! -f \"$registry\" ]]; then\n        echo \"[]\"\n        return\n    fi\n\n    jq -r '\n        to_entries\n        | map(select(.value.status == \"active\"))\n        | map({session_id: .key} + .value)\n    ' \"$registry\" 2>/dev/null || echo \"[]\"\n}\n", "structuredPatch": [{"oldStart": 86, "oldLines": 16, "newStart": 86, "newLines": 15, "lines": ["     # Find matching session by cwd with flexible matching", "     # Matches: exact, session in subdir of pane, or pane in subdir of session", "     jq -r --arg cwd \"$target_cwd\" --arg home \"$HOME\" '", "-        def norm: gsub(\"^~\"; $home);", "-", "         first(", "             to_entries[]", "             | select(.value.cwd)", "-            | {key, ncwd: (.value.cwd | norm)}", "+            | {key, ncwd: (.value.cwd | gsub(\"^~\"; $home))}", "+            | . as $x", "             | select(", "-                .ncwd == $cwd or", "-                (.ncwd | startswith($cwd + \"/\")) or", "-                ($cwd | startswith(.ncwd + \"/\"))", "+                $x.ncwd == $cwd or", "+                ($x.ncwd | startswith($cwd + \"/\")) or", "+                ($cwd | startswith($x.ncwd + \"/\"))", "             )", "         ).key // empty", "     ' \"$registry\" 2>/dev/null"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01Nz8Hi8TJez5ARhQWSGGhNW"}}
{"ts": "2025-12-18T16:26:44.901654", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "source plugins/statusline/lib/session-resolver.sh && result=$(resolve_session_by_cwd \"/home/ygg/Workspace/sandbox/marketplaces/claude\") && echo \"Found: ${result:0:8}\"", "description": "Test fixed resolver"}, "tool_use_id": "toolu_01J3YEETLM9zTJhGHJUodPjg"}}
{"ts": "2025-12-18T16:26:51.811945", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "cd /home/ygg/Workspace/sandbox/marketplaces/claude && source plugins/statusline/lib/session-resolver.sh && result=$(resolve_session_by_cwd \"/home/ygg/Workspace/sandbox/marketplaces/claude\") && echo \"Found: ${result:0:8}\"", "description": "Test with correct path"}, "tool_use_id": "toolu_01E41bJ13NyfEqSMcWjBnM3H"}}
{"ts": "2025-12-18T16:28:06.994384", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "source plugins/statusline/lib/statusline-formatter.sh && get_latest_statusline \"70b03ab6\"", "description": "Test formatter for session with statuslines"}, "tool_use_id": "toolu_014kYDJvoqBf91zhFPDScYAT"}}
{"ts": "2025-12-18T16:28:15.090708", "type": "PreToolUse", "session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "agent_session": 0, "data": {"session_id": "8d1dc830-7b44-49fe-a96d-07e93cc5ae23", "transcript_path": "/home/ygg/.claude/projects/-home-ygg-Workspace-sandbox-marketplaces-claude/8d1dc830-7b44-49fe-a96d-07e93cc5ae23.jsonl", "cwd": "/home/ygg/Workspace/sandbox/marketplaces/claude/plugins/statusline", "permission_mode": "bypassPermissions", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "cd /home/ygg/Workspace/sandbox/marketplaces/claude && source plugins/statusline/lib/statusline-formatter.sh && get_latest_statusline \"70b03ab6\" | head -c 100", "description": "Test formatter with working session"}, "tool_use_id": "toolu_01ApbXfmWc2rYLidJ1usTnD7"}}
